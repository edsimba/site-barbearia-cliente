<script>
    const API_CADASTRO = "https://sheetdb.io/api/v1/i2no77emc4yng";
    const API_AGENDAMENTO = "https://sheetdb.io/api/v1/izye8xzdqeub5";
    let USUARIO_NOME = "";

    async function logar() {
        const email = document.getElementById('login-email').value;
        const senha = document.getElementById('login-senha').value;
        try {
            const res = await fetch(`${API_CADASTRO}/search?email=${email}&senha=${senha}`);
            const data = await res.json();
            if (data.length > 0) {
                const user = data[0];
                USUARIO_NOME = user.nome; 
                document.getElementById('nome-display').innerText = "Cliente: " + USUARIO_NOME;
                document.getElementById('saldo-texto').innerText = "R$ " + parseFloat(user.saldo).toFixed(2).replace('.', ',');
                document.getElementById('tela-login').classList.add('hidden');
                document.getElementById('tela-painel').classList.remove('hidden');
                carregarDomingos();
                verificarAgendamentoAtivo(email);
            } else { alert("E-mail ou senha incorretos!"); }
        } catch (e) { alert("Erro ao conectar."); }
    }

    async function bloquearHorariosOcupados() {
        const dataEscolhida = document.getElementById('select-domingo').value;
        const selectHora = document.getElementById('select-horario');
        if(!dataEscolhida) return;

        const agora = new Date();
        const diaHoje = String(agora.getDate()).padStart(2, '0') + "/" + String(agora.getMonth() + 1).padStart(2, '0') + "/" + agora.getFullYear();
        const horaAtual = agora.getHours();
        const minAtual = agora.getMinutes();

        // Resetar opções
        for(let i = 0; i < selectHora.options.length; i++) {
            let opt = selectHora.options[i];
            if(opt.value === "") continue;
            opt.disabled = false;
            opt.text = opt.value;
            opt.style.backgroundColor = "";
            opt.style.color = "";

            // Lógica 1: Esconder se o horário já passou (caso seja hoje)
            if(dataEscolhida === diaHoje) {
                let [h, m] = opt.value.split(':');
                if(parseInt(h) < horaAtual || (parseInt(h) === horaAtual && parseInt(m) <= minAtual)) {
                    opt.disabled = true;
                    opt.text = opt.value + " (Encerrado)";
                }
            }
        }

        try {
            // Lógica 2: Bloquear se estiver "Pendente" no banco
            const res = await fetch(`${API_AGENDAMENTO}/search?data_domingo=${dataEscolhida}&status=Pendente`);
            const ocupados = await res.json();

            ocupados.forEach(ag => {
                for(let i = 0; i < selectHora.options.length; i++) {
                    let opt = selectHora.options[i];
                    if(opt.value === ag.horario) {
                        opt.disabled = true;
                        opt.text = ag.horario + " (OCUPADO)";
                        opt.style.backgroundColor = "#ffe5e5";
                        opt.style.color = "#d63031";
                    }
                }
            });
        } catch(e) { console.log("Erro ao buscar horários"); }
    }

    function carregarDomingos() {
        const select = document.getElementById('select-domingo');
        select.innerHTML = '<option value="">Selecione o Domingo</option>';
        let data = new Date();
        let domingosEncontrados = 0;
        
        // Se hoje for domingo, ele já aparece na lista
        if(data.getDay() === 0) {
            adicionarOpcaoData(select, data);
            domingosEncontrados++;
        }

        while (domingosEncontrados < 4) {
            data.setDate(data.getDate() + 1);
            if (data.getDay() === 0) {
                adicionarOpcaoData(select, data);
                domingosEncontrados++;
            }
        }
    }

    function adicionarOpcaoData(select, data) {
        let d = String(data.getDate()).padStart(2, '0');
        let m = String(data.getMonth() + 1).padStart(2, '0');
        let dataFormatada = `${d}/${m}/${data.getFullYear()}`;
        select.add(new Option(dataFormatada, dataFormatada));
    }

    async function agendarServico() {
        const serv = document.getElementById('select-servico').value;
        const hora = document.getElementById('select-horario').value;
        const dataD = document.getElementById('select-domingo').value;
        if(!serv || !hora || !dataD) return alert("Escolha data, serviço e horário!");
        
        const [nomeS, valorS, scoreS] = serv.split('|');
        const email = document.getElementById('login-email').value;

        try {
            const res = await fetch(API_AGENDAMENTO, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    "cliente_email": email,
                    "servico": nomeS,
                    "horario": hora,
                    "valor_servico": valorS,
                    "score_pendente": scoreS,
                    "status": "Pendente",
                    "data_domingo": dataD
                })
            });
            if(res.ok) {
                exibirNota({data_domingo: dataD, horario: hora, servico: nomeS, valor_servico: valorS});
            }
        } catch (e) { alert("Erro ao agendar."); }
    }

    function exibirNota(dados) {
        document.getElementById('area-agendamento').classList.add('hidden');
        document.getElementById('nota-fiscal').classList.remove('hidden');
        document.getElementById('nota-data').innerText = dados.data_domingo;
        document.getElementById('nota-hora').innerText = dados.horario;
        document.getElementById('nota-serv').innerText = dados.servico;
        document.getElementById('nota-valor').innerText = dados.valor_servico;
    }

    async function verificarAgendamentoAtivo(email) {
        const res = await fetch(`${API_AGENDAMENTO}/search?cliente_email=${email}&status=Pendente`);
        const data = await res.json();
        if(data.length > 0) exibirNota(data[0]);
    }

    // Máscara e Cadastro seguem a mesma lógica anterior...
</script>
