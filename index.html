<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbearia Score</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; justify-content: center; padding: 20px; }
        .card { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; border: 1px solid #333; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        button { background: #e67e22; color: white; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
        .score-box { background: #1b5e20; padding: 20px; text-align: center; border-radius: 12px; }
    </style>
</head>
<body>

<div class="card">
    <div id="auth-area">
        <h2 id="titulo">Entrar</h2>
        <input type="email" id="email" placeholder="E-mail">
        <input type="password" id="senha" placeholder="Senha">
        <button onclick="executarAcao()" id="btn-auth">Entrar agora</button>
        <p onclick="alternar()" id="link-alt" style="text-align:center; cursor:pointer; color:#aaa;">Não tem conta? Cadastre-se</p>
    </div>

    <div id="cliente-area" class="hidden">
        <div class="score-box">
            <span>Seu Saldo</span>
            <h1 id="saldo-display">R$ 0,00</h1>
        </div>
        <h3>Agendar Domingo</h3>
        <p>Escolha o horário e avise o barbeiro no local.</p>
        <button onclick="location.reload()" style="background:#444">Sair</button>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://vbckjvgefobuwwswlrdk.supabase.co";
    const SUPABASE_KEY = "sb_publishable_j8gX5czIDTtA3Ex3-zDPsw_n5RUbZoD";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isCadastro = false;

    function alternar() {
        isCadastro = !isCadastro;
        document.getElementById('titulo').innerText = isCadastro ? "Criar Conta" : "Entrar";
        document.getElementById('btn-auth').innerText = isCadastro ? "Cadastrar" : "Entrar agora";
        document.getElementById('link-alt').innerText = isCadastro ? "Já tem conta? Entre" : "Não tem conta? Cadastre-se";
    }

    async function executarAcao() {
        const email = document.getElementById('email').value;
        const senha = document.getElementById('senha').value;
        const btn = document.getElementById('btn-auth');

        btn.innerText = "Carregando...";
        btn.disabled = true;

        if (isCadastro) {
            const { data, error } = await _supabase.auth.signUp({ email, password: senha });
            if (error) { alert("Erro no Cadastro: " + error.message); btn.disabled = false; return; }
            // Tenta criar o perfil
            await _supabase.from('perfis').insert([{ id: data.user.id, saldo_score: 0 }]);
            alert("Conta criada! Tente fazer login agora.");
            alternar();
        } else {
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password: senha });
            if (error) { alert("Erro no Login: " + error.message); btn.disabled = false; return; }
            
            // SE CHEGOU AQUI, O LOGIN FOI SUCESSO. FORÇAR TROCA DE TELA.
            mostrarPainel(data.user);
        }
        btn.innerText = isCadastro ? "Cadastrar" : "Entrar agora";
        btn.disabled = false;
    }

    async function mostrarPainel(user) {
        document.getElementById('auth-area').classList.add('hidden');
        document.getElementById('cliente-area').classList.remove('hidden');

        const { data, error } = await _supabase.from('perfis').select('saldo_score').eq('id', user.id).single();
        if (data) {
            document.getElementById('saldo-display').innerText = `R$ ${data.saldo_score.toFixed(2)}`;
        }
    }
</script>
</body>
</html>
