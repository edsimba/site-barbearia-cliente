<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo - Barbearia</title>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        .card { 
            background: white; padding: 20px; border-radius: 15px; 
            margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 5px solid #b08d57;
        }
        .info { margin-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        
        button { 
            padding: 10px 15px; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 12px;
        }

        .btn-confirm { background: #27ae60; color: white; }
        .btn-cancel { background: #d63031; color: white; }
        
        /* NOVOS BOTÕES DE RESGATE */
        .btn-permitir { background: #2980b9; color: white; }
        .btn-negar { background: #7f8c8d; color: white; }

        .tag-resgate { 
            background: #ffeaa7; color: #d35400; 
            padding: 5px 10px; border-radius: 5px; 
            font-weight: bold; display: inline-block; margin-top: 5px;
        }
        h2 { color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h2>Agendamentos Pendentes</h2>
    <div id="lista-agendamentos">Carregando...</div>
</div>

<script>
    const API_CADASTRO = "https://sheetdb.io/api/v1/i2no77emc4yng";
    const API_AGENDAMENTO = "https://sheetdb.io/api/v1/izye8xzdqeub5";

    async function buscarAgendamentos() {
        try {
            const res = await fetch(`${API_AGENDAMENTO}/search?status=Pendente`);
            const dados = await res.json();
            const lista = document.getElementById('lista-agendamentos');
            lista.innerHTML = "";

            if(dados.length === 0) {
                lista.innerHTML = "<p>Nenhum agendamento pendente.</p>";
                return;
            }

            dados.forEach((ag, index) => {
                const solicitouResgate = ag.usar_score === "Sim";
                
                lista.innerHTML += `
                    <div class="card">
                        <div class="info">
                            <strong>Cliente:</strong> ${ag.cliente_email}<br>
                            <strong>Serviço:</strong> ${ag.servico} - ${ag.data_domingo} às ${ag.horario}<br>
                            ${solicitouResgate ? `<span class="tag-resgate">⚠️ SOLICITOU USAR SCORE</span>` : ''}
                        </div>
                        <div class="btn-group">
                            ${solicitouResgate ? `
                                <button class="btn-permitir" onclick="processarResgate('${ag.cliente_email}', '${index}', 'Sim')">Permitir Resgate (Zerar Saldo)</button>
                                <button class="btn-negar" onclick="processarResgate('${ag.cliente_email}', '${index}', 'Não')">Negar Resgate</button>
                            ` : `
                                <button class="btn-confirm" onclick="confirmarAtendimento('${ag.cliente_email}', '${ag.score_pendente}', '${index}')">Confirmar e Somar Score</button>
                            `}
                            <button class="btn-cancel" onclick="cancelarAgendamento('${index}')">Cancelar Vaga</button>
                        </div>
                    </div>
                `;
            });
        } catch (e) { console.error("Erro ao buscar."); }
    }

    // FUNÇÃO QUE ZERA O SALDO E CONCLUI
    async function processarResgate(email, index, permissao) {
        if (permissao === 'Sim') {
            const confirmacao = confirm("Deseja PERMITIR o resgate? O saldo do cliente será ZERADO.");
            if (!confirmacao) return;

            // 1. Zera o saldo do cliente no banco de cadastros
            await fetch(`${API_CADASTRO}/email/${email}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ "saldo": 0 })
            });
            alert("Saldo zerado com sucesso!");
        } else {
            alert("Resgate negado. O atendimento será processado normalmente.");
        }

        // 2. Conclui o agendamento
        await atualizarStatus(index, "Concluido");
    }

    // FUNÇÃO NORMAL DE CONFIRMAR (SOMA SCORE)
    async function confirmarAtendimento(email, scoreParaSomar, index) {
        try {
            const res = await fetch(`${API_CADASTRO}/search?email=${email}`);
            const user = await res.json();
            const novoSaldo = (parseFloat(user[0].saldo) || 0) + parseFloat(scoreParaSomar);

            await fetch(`${API_CADASTRO}/email/${email}`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ "saldo": novoSaldo })
            });

            await atualizarStatus(index, "Concluido");
            alert("Score adicionado e atendimento concluído!");
        } catch (e) { alert("Erro ao confirmar."); }
    }

    async function cancelarAgendamento(index) {
        if(confirm("Deseja cancelar essa vaga?")) {
            await atualizarStatus(index, "Cancelado");
            alert("Agendamento cancelado.");
        }
    }

    async function atualizarStatus(index, novoStatus) {
        // Busca o ID interno da linha para atualizar corretamente
        const res = await fetch(`${API_AGENDAMENTO}`);
        const todos = await res.json();
        // Filtramos apenas os pendentes para achar o índice correto na planilha original
        const pendentes = todos.filter(a => a.status === "Pendente");
        const agendamentoOriginal = pendentes[index];

        await fetch(`${API_AGENDAMENTO}/horario/${agendamentoOriginal.horario}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ "status": novoStatus })
        });
        buscarAgendamentos();
    }

    buscarAgendamentos();
    setInterval(buscarAgendamentos, 30000); // Atualiza a cada 30 segundos
</script>

</body>
</html>
