<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM - Barbearia Score</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: white; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .card-agendamento { background: #1e1e1e; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left; position: relative; border-left: 5px solid #e67e22; }
        
        /* Bot√µes */
        .btn-confirmar { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 14px; }
        .btn-excluir { background: #c0392b; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 5px; width: 100%; opacity: 0.8; }
        
        /* Bot√µes de Resgate */
        .btn-resgate-sim { background: #2980b9; color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; font-size: 14px; }
        .btn-resgate-nao { background: #7f8c8d; color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-top: 5px; width: 100%; }

        .status-badge { background: #f1c40f; color: black; padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .resgate-badge { background: #d35400; color: white; padding: 5px; border-radius: 4px; font-size: 12px; font-weight: bold; text-align: center; margin-top: 10px; display: block; }
        
        .cliente-nome { color: #e67e22; font-size: 18px; font-weight: bold; margin: 10px 0 5px 0; }
        .info-linha { font-size: 14px; margin: 3px 0; color: #ccc; }
        h2 { border-bottom: 2px solid #e67e22; padding-bottom: 10px; margin-top: 30px; }
        .loading { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Painel do Barbeiro ‚úÇÔ∏è</h1>
    <button onclick="carregarAgendamentos()" style="background:#333; color:white; padding:12px; width:100%; border-radius:8px; border:1px solid #444; margin-bottom:20px; cursor:pointer; font-weight: bold;">üîÑ ATUALIZAR LISTA</button>
    
    <h2>Agendamentos Pendentes</h2>
    <div id="lista-pendentes">
        <p class="loading">Buscando agendamentos...</p>
    </div>
</div>

<script>
    const API_CADASTRO = "https://sheetdb.io/api/v1/i2no77emc4yng";
    const API_AGENDAMENTO = "https://sheetdb.io/api/v1/izye8xzdqeub5";

    async function carregarAgendamentos() {
        const div = document.getElementById('lista-pendentes');
        div.innerHTML = "<p class='loading'>Carregando dados da planilha...</p>";

        try {
            const resAgend = await fetch(`${API_AGENDAMENTO}/search?status=Pendente`);
            const agendamentos = await resAgend.json();
            const resClientes = await fetch(API_CADASTRO);
            const clientes = await resClientes.json();

            if (agendamentos.length === 0) {
                div.innerHTML = "<p style='color: #888;'>Nenhum agendamento pendente para hoje.</p>";
                return;
            }

            div.innerHTML = "";
            agendamentos.forEach((item) => {
                const dadosCliente = clientes.find(c => c.email === item.cliente_email);
                const nomeExibir = dadosCliente ? dadosCliente.nome : "Cliente n√£o encontrado";
                const whatsExibir = dadosCliente ? dadosCliente.whatsapp : "Sem n√∫mero";
                const saldoAtual = dadosCliente ? parseFloat(dadosCliente.saldo).toFixed(2) : "0.00";
                
                // Verifica explicitamente se √© "Sim"
                const pediuResgate = item.usar_score === "Sim";

                let botoesAcao = "";

                if (pediuResgate) {
                    botoesAcao = `
                        <div class="resgate-badge">‚ö†Ô∏è CLIENTE QUER USAR O SALDO (R$ ${saldoAtual})</div>
                        <button class="btn-resgate-sim" onclick="permitirResgate('${item.cliente_email}', '${nomeExibir}')">
                            ‚úÖ PERMITIR (ZERAR SALDO E CONCLUIR)
                        </button>
                        <button class="btn-resgate-nao" onclick="confirmarPagamento('${item.cliente_email}', '${item.score_pendente}', '${nomeExibir}')">
                            ‚ùå NEGAR (COBRAR NORMAL)
                        </button>
                    `;
                } else {
                    botoesAcao = `
                        <button class="btn-confirmar" onclick="confirmarPagamento('${item.cliente_email}', '${item.score_pendente}', '${nomeExibir}')">
                            CONFIRMAR PAGAMENTO E LIBERAR SCORE
                        </button>
                    `;
                }

                div.innerHTML += `
                    <div class="card-agendamento">
                        <span class="status-badge">Aguardando</span>
                        <div class="cliente-nome">${nomeExibir}</div>
                        <div class="info-linha">üì± WhatsApp: ${whatsExibir}</div>
                        <div class="info-linha">üíá‚Äç‚ôÇÔ∏è Servi√ßo: <strong>${item.servico}</strong></div>
                        <div class="info-linha">üí∞ Valor: R$ ${item.valor_servico}</div>
                        <div class="info-linha">üìÖ Data: ${item.data_domingo} √†s ${item.horario}</div>
                        <div class="info-linha" style="color: #27ae60; font-weight: bold; margin-top: 10px;">
                            ‚≠ê Score a liberar: R$ ${item.score_pendente.replace('.', ',')}
                        </div>
                        
                        ${botoesAcao}

                        <button class="btn-excluir" onclick="cancelarAgendamento('${item.cliente_email}', '${item.horario}')">CANCELAR AGENDAMENTO</button>
                    </div>
                `;
            });
        } catch (e) {
            div.innerHTML = "<p style='color: red;'>Erro ao conectar. Verifique a internet.</p>";
        }
    }

    // --- FUN√á√ÉO PADR√ÉO: SOMA O SCORE (E USADA QUANDO NEGA O RESGATE) ---
    async function confirmarPagamento(email, score, nome) {
        if (!confirm(`Confirmar pagamento de ${nome}? \nO score ser√° ADICIONADO ao saldo.`)) return;

        try {
            const encodedEmail = encodeURIComponent(email); // Prote√ß√£o para emails com caracteres especiais
            const resUser = await fetch(`${API_CADASTRO}/search?email=${encodedEmail}`);
            const user = await resUser.json();

            if (user.length > 0) {
                const saldoAntigo = parseFloat(user[0].saldo) || 0;
                const bonus = parseFloat(score) || 0;
                const novoSaldo = (saldoAntigo + bonus).toFixed(2);

                await fetch(`${API_CADASTRO}/email/${encodedEmail}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "saldo": novoSaldo })
                });

                await fetch(`${API_AGENDAMENTO}/cliente_email/${encodedEmail}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "status": "Concluido" })
                });

                alert("Pagamento confirmado! Score somado.");
                carregarAgendamentos();
            }
        } catch (e) { alert("Erro ao processar."); }
    }

    // --- FUN√á√ÉO NOVA: ZERA O SALDO (RESGATE) ---
    async function permitirResgate(email, nome) {
        if (!confirm(`ATEN√á√ÉO!\nVoc√™ vai autorizar o uso do saldo de ${nome}.\n\nO saldo do cliente ser√° ZERADO (R$ 0,00).`)) return;

        try {
            const encodedEmail = encodeURIComponent(email); // Prote√ß√£o vital

            // Zera o saldo do cliente (Enviando "0" como string para garantir)
            await fetch(`${API_CADASTRO}/email/${encodedEmail}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "saldo": "0" }) 
            });

            // Conclui o agendamento
            await fetch(`${API_AGENDAMENTO}/cliente_email/${encodedEmail}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "status": "Concluido" })
            });

            alert("Resgate autorizado! O saldo foi zerado.");
            carregarAgendamentos();
        } catch (e) { alert("Erro ao processar o resgate."); }
    }

    async function cancelarAgendamento(email, hora) {
        if (!confirm("Cancelar agendamento?")) return;
        try {
            const encodedEmail = encodeURIComponent(email);
            await fetch(`${API_AGENDAMENTO}/cliente_email/${encodedEmail}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ "status": "Cancelado" })
            });
            alert("Agendamento cancelado.");
            carregarAgendamentos();
        } catch (e) { alert("Erro ao cancelar."); }
    }

    carregarAgendamentos();
    setInterval(carregarAgendamentos, 30000);
</script>
</body>
</html>
